---
title: "TMCD Frames from Video (colored)"
output: html_document     
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)

source("tmcd_functions.R")

library(robustmatrix)  
library(ggplot2)        
library(patchwork) 
library(grid)
library(gridExtra)
library(ggtext)
library(cowplot)

options(scipen = 999)
```

```{r}
##  Load the demo colour video ----------------------
load(url("https://wis.kuleuven.be/stat/robust/Programs/DO/do-video-data-rdata"))
## 'Video' shape: (n_frame , height , width , 3)
cat("Video dimensions:", paste(dim(Video), collapse = " x "), "\n")
```
```{r}
############################################################
# BUILD DATA SETS                                      
############################################################
## 1‑A  Grayscale matrix data  (MMCD paradigm) ------------
video_gray <- apply(Video, c(1, 2, 3), mean)        
X_mmcd     <- aperm(video_gray, c(2, 3, 1))         
X_mmcd_200 <- X_mmcd[ , , 1:200, drop = FALSE]      # first 200 frames

## 1‑B  Colour tensor data  (TMCD paradigm) ---------------
X_tmcd     <- Video                                 
X_tmcd_200 <- X_tmcd[1:200, , , , drop = FALSE]     # first 200 frames


```




```{r}
############################################################
#  COVARIANCE‑MATRIX MLEs (FIRST 200 FRAMES)            
############################################################
## 2‑A  Matrix normal MLE  (MMCD line) --------------------

mmle_time <- system.time(                    
  mmle_res <- mmle(X_mmcd_200, lambda = 0)   # pure MLE
)

cat(sprintf("MMLE runtime:  %.2f seconds\n", mmle_time["elapsed"]))

## 2‑B  Flip–flop MLE  (TMCD line) ------------------------

ff_time <- system.time({ 
  M_hat <- apply(X_tmcd_200, c(2, 3, 4), mean)         # mean tensor
  
  C1 <- sweep(X_tmcd_200, c(2, 3, 4), M_hat, "-")      # (n,p1,p2,p3)
  C2 <- aperm(C1, c(1, 3, 4, 2))                       # (n,p2,p3,p1)
  C3 <- aperm(C1, c(1, 4, 2, 3))                       # (n,p3,p1,p2)
  
  p1 <- dim(C1)[2];  p2 <- dim(C1)[3];  p3 <- dim(C1)[4]
  
  Sigma1_0   <- diag(1, p1)
  Sigma2_0   <- diag(1, p2)
  Sigma3_0   <- diag(1, p3)
  invSqrt2_0 <- diag(1, p2)
  invSqrt3_0 <- diag(1, p3)
  
                                
    ff_res <- flipFlopMLE(
      C1, C2, C3,
      Sigma1init   = Sigma1_0,
      Sigma2init   = Sigma2_0,
      Sigma3init   = Sigma3_0,
      invSqrt2init = invSqrt2_0,
      invSqrt3init = invSqrt3_0,
      maxIter      = 100,
      tol          = 1e-3
    )
    invSqrt3_hat <- inverseSquareRootMatrix(ff_res$Sigma3)
})

cat(sprintf("TMLE runtime: %.2f seconds\n", ff_time["elapsed"]))

```

```{r}
############################################################
# SQUARED MAHALANOBIS DISTANCES  (ALL FRAMES)          
############################################################
## 3‑A  Matrix case (MMCD) --------------------------------
MD2_mmcd <- mmd(
  X        = X_mmcd,                     # all frames
  mu       = mmle_res$mu,
  cov_row  = mmle_res$cov_row_inv,
  cov_col  = mmle_res$cov_col_inv,
  inverted = TRUE                        
)

## 3‑B  Tensor case (TMCD) --------------------------------
C_full <- sweep(X_tmcd, c(2, 3, 4), M_hat, "-")      

MD2_tmcd <- computeTensorMD(
  C_full,
  invSqrt1 = ff_res$invSqrt1,
  invSqrt2 = ff_res$invSqrt2,
  invSqrt3 = invSqrt3_hat,
  returnContributions = FALSE
)


```


```{r}
############################################################
# PLOTTING                                            
############################################################
p_joint <- ggplot(
  rbind(
    data.frame(Frame = seq_along(MD2_mmcd),
               MD2   = MD2_mmcd,
               Method = "MMLE (grayscale)"),
    data.frame(Frame = seq_along(MD2_tmcd),
               MD2   = MD2_tmcd,
               Method = "TMLE (colour)")
  ),
  aes(Frame, MD2, colour = Method)
) +
  geom_line(linewidth = 0.4) +
  geom_point(size = 0.7) +
  labs(
    title  = "Mahalanobis Distances for MMLE (grayscale) and TMLE (colour)",
    x      = "Frame index",
    y      = "Squared Mahalanobis distance",
    colour = NULL
  ) +
  scale_colour_manual(
    values = c("MMLE (grayscale)" = "#1F77B4",
               "TMLE (colour)"    = "#D62728")
  ) +
  theme_classic() +
  theme(legend.position = "bottom")

n_frames  <- length(MD2_mmcd)
tick_step <- 25
x_axis <- scale_x_continuous(
  limits = c(1, n_frames),
  breaks = seq(0, n_frames, by = tick_step),
  expand = c(0, 0)
)

plt_mmcd <- ggplot(
  data.frame(Frame = 1:n_frames, MD2 = MD2_mmcd),
  aes(Frame, MD2)
) +
  geom_line(linewidth = 0.4, colour = "#1F77B4") +
  geom_point(size = 0.7, colour = "#1F77B4") +
  x_axis +
  labs(
    title = "Mahalanobis Distances for MMLE (grayscale)",
    x     = "Frame index",
    y     = "Squared Mahalanobis distance"
  ) +
  theme_classic()

plt_tmcd <- ggplot(
  data.frame(Frame = 1:n_frames, MD2 = MD2_tmcd),
  aes(Frame, MD2)
) +
  geom_line(linewidth = 0.4, colour = "#D62728") +
  geom_point(size = 0.7, colour = "#D62728") +
  x_axis +
  labs(
    title = "Mahalanobis Distances for TMLE (colour)",
    x     = "Frame index",
    y     = "Squared Mahalanobis distance"
  ) +
  theme_classic()


p_joint
plt_mmcd
plt_tmcd
```

```{r}
#   write a multi‑page PD
#   page 1 : joint plot
#   page 2 : MMCD only
#   page 3 : TMCD only
pdf("fig_mahalanobis_all.pdf",
    onefile = TRUE,   
    family = "Helvetica",                     
    useDingbats = FALSE)                      

print(p_joint)
print(plt_mmcd)
print(plt_tmcd)

dev.off()
```


```{r}
############################################################
# Max MD2 frames over several frame ranges                 
############################################################
ranges <- list(
  `1–475` = 1:475,
  `475–500` = 475:500,
  `1–200` = 1:200,
  `200–350` = 200:350
)


max_frame <- function(md2_vector, idx_range) {
  idx_local_max <- which.max(md2_vector[idx_range])  
  idx_range[idx_local_max]                            
}


max_mmcd <- sapply(ranges, max_frame, md2_vector = MD2_mmcd)
max_tmcd <- sapply(ranges, max_frame, md2_vector = MD2_tmcd)


for (r in names(ranges)) {
  cat(sprintf("MMLE  – interval %s: frame %d has the largest MD2\n",
              r, max_mmcd[[r]]))
  cat(sprintf("TMLE  – interval %s: frame %d has the largest MD2\n\n",
              r, max_tmcd[[r]]))
}
```
```{r}
############################################################
# Full‑colour snapshots                 
############################################################


frames_to_show <- c(42, 74, 228, 422, 423, 486, 500)

h <- dim(Video)[2]    # image height
w <- dim(Video)[3]    # image width

build_long_rgb <- function(f) {
  df <- expand.grid(y = 1:h, x = 1:w)        # y first, x second
  df$r <- as.vector(Video[f, , , 1] / 255)
  df$g <- as.vector(Video[f, , , 2] / 255)
  df$b <- as.vector(Video[f, , , 3] / 255)
  df$rgb_val <- with(df, rgb(r, g, b))
  df
}



make_frame_plot <- function(img_df, frame_id) {
  ggplot(img_df, aes(x, y)) +
    geom_raster(aes(fill = rgb_val)) +
    scale_fill_identity() +
    coord_fixed() +
    
   
    annotate(
      "text",
      x      = w / 2,              
      y      = 1,                  
      label  = paste("Frame", frame_id),
      vjust  = 1.1,                
      colour = "white",
      size   = 6,
      fontface = "bold"
    ) +


    theme_void() +
    theme(
      panel.border = element_rect(colour = "black", fill = NA),
      plot.title   = element_blank()    
    ) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_reverse(expand = c(0, 0))
}

plots <- lapply(frames_to_show, function(f) {
  make_frame_plot(build_long_rgb(f), f)
})


for (p in plots) print(p)



```

```{r}
layout_plot <- wrap_plots(
  plots[order(frames_to_show)],  
  ncol  = 2,
  byrow = FALSE                  
)


ggsave(
  filename = "frames_grid.pdf",
  plot     = layout_plot,
  device   = cairo_pdf,          

)

```






```{r}
############################################################
# Contaminated cells -- overlay of MMCD / TMCD masks
############################################################



t_mmcd <- 0
t_tmcd <- 0

plot_one <- function(img_df, mask, frame, subtitle) {
  idx <- which(mask, arr.ind = TRUE)

  ggplot() +
    geom_tile(data = img_df,  aes(x, y, fill = rgb_val),
              width = 1, height = 1, show.legend = FALSE) +
    scale_fill_identity() +
    geom_tile(data = data.frame(x = idx[, 2], y = idx[, 1]),
              aes(x, y), fill = "red", alpha = .6,
              width = 1, height = 1, show.legend = FALSE) +
    coord_fixed() +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_reverse(expand = c(0, 0)) +
    theme_void()                        
}
make_overlay_pair <- function(frame, top) {
  img_df <- build_long_rgb(frame)

  t_mmcd <<- t_mmcd + system.time({
    shv <- matrixShapley(
      X        = X_mmcd[ , , frame, drop = FALSE],
      mu       = mmle_res$mu,
      cov_row  = mmle_res$cov_row_inv,
      cov_col  = mmle_res$cov_col_inv,
      inverted = TRUE,
      type     = "cell"
    )[ , , 1]
    mask_mmcd <- abs(shv) > quantile(abs(shv), 1 - top)
  })[3]

  h <- dim(Video)[2]; w <- dim(Video)[3]

  t_tmcd <<- t_tmcd + system.time({
    C_f <- sweep(array(X_tmcd[frame, , , ], dim = c(1, h, w, 3)),
                 c(2, 3, 4), M_hat, "-")
    contrib <- computeTensorMD(
      C_f,
      invSqrt1 = ff_res$invSqrt1,
      invSqrt2 = ff_res$invSqrt2,
      invSqrt3 = invSqrt3_hat,
      returnContributions = TRUE
    )$contributions[1, , , ]
    agg <- apply(contrib, c(1, 2), sum)
    mask_tmcd <- agg > quantile(agg, 1 - top)
  })[3]

  p1 <- plot_one(img_df, mask_mmcd, frame, "MMCD")
  p2 <- plot_one(img_df, mask_tmcd, frame, "TMCD")
  plot_grid(p1, p2, ncol = 2, align = "hv")
}

make_composite <- function(top_level, frames = c(487, 491, 495, 500)) {
  pairs <- lapply(frames, make_overlay_pair, top = top_level)
  top_percent <- format(round(top_level * 100, 2), trim = TRUE, drop0trailing = TRUE)

  header <- plot_grid(
    ggdraw() + draw_label("MMCD (grayscale)", fontface = "bold", size = 9, hjust = .5),
    ggdraw() + draw_label("TMCD (coloured)",  fontface = "bold", size = 9, hjust = .5),
    ncol = 2
  )

  body  <- plot_grid(plotlist = pairs, ncol = 1, align = "hv")
  title <- ggdraw() + draw_label(sprintf("Top %s%% cells (red)", top_percent),
                                 fontface = "bold", size = 10, hjust = .5)

  plot_grid(title, header, body, ncol = 1, rel_heights = c(0.06, 0.06, 1))
}

levels <- c(0.005, 0.01, 0.04, 0.10)

pdf("overlay_levels.pdf", onefile = TRUE, width = 8, height = 10)
for (alpha in levels) print(make_composite(alpha))
dev.off()

cat(sprintf("Total MMCD time: %.2f s\n", t_mmcd))
cat(sprintf("Total TMCD time: %.2f s\n", t_tmcd))

```



```{r}
set.seed(123)
t_tmcd <- system.time(
  tmcd_res <- tmcd(
    X                = X_tmcd,
    alpha            = 0.75,
    nSubsets         = 10,
    nBest            = 10,
    maxIterCshort    = 2,
    maxIterFFshort   = 2,
    maxIterCfull     = 20,
    maxIterFFfull    = 100,
    tolC             = 1e-4,
    tolFF            = 1e-3,
    beta             = 0.9999
  )
)
cat(sprintf("TMCD runtime: %.2f seconds\n", t_tmcd["elapsed"]))

```

```{r}
cat("Outlier indices:", 
    paste(tmcd_res$outliers, collapse = ", "), "\n")
```

```{r}
set.seed(1)          
t_mmcd <- system.time(
  mmcd_res <- mmcd(
    X        = X_mmcd,  
    alpha    = 0.75,      
    lambda   = 0,       
    nsamp    = 1,      
    nthreads = 1        
  )
)
cat(sprintf("MMCD runtime: %.2f seconds\n", t_mmcd["elapsed"]))

```
```{r}



make_frame_plot_num <- function(f) {
  ggplot(build_long_rgb(f), aes(x, y)) +
    geom_raster(aes(fill = rgb_val)) +
    scale_fill_identity() +
    coord_fixed() +
    theme_void() +
    labs(title = paste("Frame", f)) +         
    theme(
      plot.title   = element_text(hjust = 0.5),
      panel.border = element_rect(colour = "black", fill = NA),
      plot.margin  = margin(0, 0, 0, 0)
    ) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_reverse(expand = c(0, 0))
}

layout_plot <- wrap_plots(lapply(482:485, make_frame_plot_num), ncol = 4)

ggsave("frames_482_485_grid.pdf", layout_plot, device = cairo_pdf)

```

```{r}
#######################################################################
# 1) Mahalanobis distances: MMLE, TMLE, TMCD --------------------------
#######################################################################

## MMLE ---------------------------------------------------------------
t_mmle_md <- system.time(
  MD2_mmle <- mmd(
    X        = X_mmcd,
    mu       = mmle_res$mu,
    cov_row  = mmle_res$cov_row_inv,
    cov_col  = mmle_res$cov_col_inv,
    inverted = TRUE
  )
)["elapsed"]

## TMLE ---------------------------------------------------------------
t_tmle_md <- system.time({
  C_full  <- sweep(X_tmcd, c(2, 3, 4), M_hat, "-")
  MD2_tmle <- computeTensorMD(
    C_full,
    invSqrt1 = ff_res$invSqrt1,
    invSqrt2 = ff_res$invSqrt2,
    invSqrt3 = invSqrt3_hat,
    returnContributions = FALSE
  )
})["elapsed"]

## TMCD ---------------------------------------------------------------
invSqrt1_tmcd <- inverseSquareRootMatrix(tmcd_res$Sigma1)
invSqrt2_tmcd <- inverseSquareRootMatrix(tmcd_res$Sigma2)
invSqrt3_tmcd <- inverseSquareRootMatrix(tmcd_res$Sigma3)

t_tmcd_md <- system.time({
  C_full2 <- sweep(X_tmcd, c(2, 3, 4), tmcd_res$M, "-")
  MD2_tmcd <- computeTensorMD(
    C_full2,
    invSqrt1 = invSqrt1_tmcd,
    invSqrt2 = invSqrt2_tmcd,
    invSqrt3 = invSqrt3_tmcd,
    returnContributions = FALSE
  )
})["elapsed"]

total_md <- t_mmle_md + t_tmle_md + t_tmcd_md
cat(sprintf("MMLE MD2: %.2f s\nTMLE MD2: %.2f s\nTMCD MD2: %.2f s\nTOTAL: %.2f s\n",
            t_mmle_md, t_tmle_md, t_tmcd_md, total_md))

#######################################################################
# 2) Overlay masks: three‑column PDF ----------------------------------
#######################################################################

plot_one <- function(img_df, mask) {
  idx <- which(mask, arr.ind = TRUE)
  ggplot() +
    geom_tile(data = img_df, aes(x, y, fill = rgb_val),
              width = 1, height = 1, show.legend = FALSE) +
    scale_fill_identity() +
    geom_tile(data = data.frame(x = idx[, 2], y = idx[, 1]),
              aes(x, y), fill = "red", alpha = .6,
              width = 1, height = 1, show.legend = FALSE) +
    coord_fixed() +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_reverse(expand = c(0, 0)) +
    theme_void()
}

make_overlay_triple <- function(frame, top) {
  img_df <- build_long_rgb(frame)

  ## MMLE mask ---------------------------------------------------------
  shv <- matrixShapley(
    X        = X_mmcd[, , frame, drop = FALSE],
    mu       = mmle_res$mu,
    cov_row  = mmle_res$cov_row_inv,
    cov_col  = mmle_res$cov_col_inv,
    inverted = TRUE,
    type     = "cell"
  )[ , , 1]
  mask_mmle <- abs(shv) > quantile(abs(shv), 1 - top)

  ## TMLE mask ---------------------------------------------------------
  h <- dim(Video)[2]; w <- dim(Video)[3]
  C_f <- sweep(array(X_tmcd[frame, , , ], dim = c(1, h, w, 3)),
               c(2, 3, 4), M_hat, "-")
  contrib <- computeTensorMD(
    C_f,
    invSqrt1 = ff_res$invSqrt1,
    invSqrt2 = ff_res$invSqrt2,
    invSqrt3 = invSqrt3_hat,
    returnContributions = TRUE
  )$contributions[1, , , ]
  mask_tmle <- apply(contrib, c(1, 2), sum) > quantile(apply(contrib, c(1, 2), sum), 1 - top)

  ## TMCD mask ---------------------------------------------------------
  C_f2 <- sweep(array(X_tmcd[frame, , , ], dim = c(1, h, w, 3)),
                c(2, 3, 4), tmcd_res$M, "-")
  contrib2 <- computeTensorMD(
    C_f2,
    invSqrt1 = invSqrt1_tmcd,
    invSqrt2 = invSqrt2_tmcd,
    invSqrt3 = invSqrt3_tmcd,
    returnContributions = TRUE
  )$contributions[1, , , ]
  mask_tmcd <- apply(contrib2, c(1, 2), sum) > quantile(apply(contrib2, c(1, 2), sum), 1 - top)

  p1 <- plot_one(img_df, mask_mmle)
  p2 <- plot_one(img_df, mask_tmle)
  p3 <- plot_one(img_df, mask_tmcd)
  plot_grid(p1, p2, p3, ncol = 3, align = "hv")
}

make_composite <- function(top_level, frames = c(487, 491, 495, 500)) {
  triple <- lapply(frames, make_overlay_triple, top = top_level)
  top_txt <- format(round(top_level * 100, 2), trim = TRUE, drop0trailing = TRUE)

  header <- plot_grid(
    ggdraw() + draw_label("MMLE", fontface = "bold", size = 9, hjust = .5),
    ggdraw() + draw_label("TMLE", fontface = "bold", size = 9, hjust = .5),
    ggdraw() + draw_label("TMCD", fontface = "bold", size = 9, hjust = .5),
    ncol = 3
  )
  body  <- plot_grid(plotlist = triple, ncol = 1, align = "hv")
  title <- ggdraw() + draw_label(sprintf("Top %s%% cells (red)", top_txt),
                                 fontface = "bold", size = 10, hjust = .5)

  plot_grid(title, header, body, ncol = 1, rel_heights = c(0.06, 0.06, 1))
}

levels <- c(0.005, 0.01, 0.04, 0.10)

pdf("overlay_levels_3col.pdf", onefile = TRUE, width = 12, height = 10)
for (alpha in levels) print(make_composite(alpha))
dev.off()


```
